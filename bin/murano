#!/usr/bin/env ruby
# Last Modified: 2017.07.01 /coding: utf-8
# frozen_string_literal: true

# Copyright © 2016-2017 Exosite LLC.
# License: MIT. See LICENSE.txt.
#  vim:tw=0:ts=2:sw=2:et:ai

require 'commander/import'
require 'dotenv'
require 'highline'
require 'pathname'
#require 'pp'
require 'rainbow'
require 'rubygems'
require 'MrMurano'

# DEVs: Store environs in an .env file that gets loaded here. Alternatively,
#   run a Bash or similar script before you start developing.
Dotenv.load

# Don't drop traces on ^C.
# EXPLAIN/2017-06-30: [lb] not sure what "drop traces" means.
#   What happens if we don't trap Ctrl-C?
# NOTE: The second parameter is either a string, or a command or block to
#   call or run. Ruby honors certain special strings, like 'EXIT':
#   "If the command is “EXIT”, the script will be terminated by the signal."
#   Per https://ruby-doc.org/core-2.2.0/Signal.html
Signal.trap('INT', 'EXIT')

program :version, MrMurano::VERSION

program :description, %(
  Manage Applications and Products in Exosite's Murano
).strip

default_command :help

# Look for .murano/config files.
$cfg = MrMurano::Config.new
$cfg.load

# Look for a legacy Solutionfile.json.
$project = MrMurano::ProjectFile.new
$project.load

# Most commands should be run from within a Murano project (sub-)directory.
# If user is running a project command not within a project directory,
# we'll print a message now and exit the app from run_active_command later.
runner = ::Commander::Runner.instance
the_cmd = runner.active_command
unless the_cmd.name == 'help' || the_cmd.project_not_required || $cfg.project_exists
  MrMurano::Verbose.error %(The "#{the_cmd.name}" command only works in a Murano project.)
  say %(Please change to a project directory, or run `murano init` to create a new project.)
  # Note that commnander-rb uses an at_exit hook, which we hack around.
  runner.command_exit = 1
end
#module MrMurano
#  IS_PROJECT_CMD = !(the_cmd.name == "help" || the_cmd.project_not_required)
#end

# Look for plug-ins.
pgds = [
  Pathname.new(Dir.home) + '.mrmurano' + 'plugins',
  Pathname.new(Dir.home) + '.murano' + 'plugins',
]
# Add plugin dirs from configs
# This is run before the command line options are parsed, so need to check old way.
unless ARGV.include? '--skip-plugins'
  pgds << Pathname.new(ENV['MR_MURANO_PLUGIN_DIR']) if ENV.is_a? 'MR_MURANO_PLUGIN_DIR'
  pgds << Pathname.new(ENV['MURANO_PLUGIN_DIR']) if ENV.is_a? 'MURANO_PLUGIN_DIR'
  pgds.each do |path|
    next unless path.exist?
    path.each_child do |plugin|
      next if plugin.directory?
      next unless plugin.readable?
      next if plugin.basename.fnmatch('.*') # don't read anything starting with .
      begin
        require plugin.to_s
      #rescue Exception => err
      rescue StandardError => err
        $stderr.puts "Failed to load plugin at #{plugin} because #{err}"
      end
    end
  end
end

